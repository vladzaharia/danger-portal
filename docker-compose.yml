version: '3.8'

services:
  danger-portal:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # PocketID OIDC Configuration
      # External URL for frontend redirects
      - POCKETID_ISSUER=${POCKETID_ISSUER:-https://id.danger.direct}
      # Internal URL for server-side OAuth operations (container-to-container)
      - POCKETID_ISSUER_INTERNAL=${POCKETID_ISSUER_INTERNAL:-http://pocket-id:8080}
      - CLIENT_ID=${CLIENT_ID:-danger-portal}
      - CLIENT_SECRET=${CLIENT_SECRET}
      - REDIRECT_URI=${REDIRECT_URI:-https://danger.direct/api/auth/callback}

      # Session Configuration
      - SESSION_SECRET=${SESSION_SECRET}

      # Kiosk Display Configuration
      - KIOSK_WIFI_SSID=${KIOSK_WIFI_SSID}
      - KIOSK_WIFI_PASSWORD=${KIOSK_WIFI_PASSWORD}
      - KIOSK_PORTAL_URL=${KIOSK_PORTAL_URL}

      # Node Configuration
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=3000
    volumes:
      # Mount the CDN directory for static assets
      - ${CDN_PATH:-./cdn}:/app/dist/client/cdn:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s